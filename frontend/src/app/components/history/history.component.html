<div class="history-container">
  <!-- Header -->
  <div class="history-header">
    <h1>üìä Hist√≥rico de M√£os</h1>
    <p class="subtitle">An√°lise completa de todas as suas m√£os de poker</p>
  </div>

  <!-- Filtros -->
  <div class="filters-section">
    <div class="filters-grid">
      <!-- Filtro por Gap -->
      <div class="filter-group">
        <label>Status:</label>
        <select [(ngModel)]="filters.gap_filter" (change)="onFilterChange()">
          <option *ngFor="let option of filterOptions.gap_options" [value]="option.value">
            {{option.label}}
          </option>
        </select>
      </div>

      <!-- Filtro por Posi√ß√£o -->
      <div class="filter-group">
        <label>Posi√ß√£o:</label>
        <select [(ngModel)]="filters.position_filter" (change)="onFilterChange()">
          <option value="">Todas</option>
          <option *ngFor="let position of filterOptions.positions" [value]="position">
            {{position}}
          </option>
        </select>
      </div>

      <!-- Filtro por A√ß√£o -->
      <div class="filter-group">
        <label>A√ß√£o:</label>
        <select [(ngModel)]="filters.action_filter" (change)="onFilterChange()">
          <option value="">Todas</option>
          <option *ngFor="let action of filterOptions.actions" [value]="action">
            {{action}}
          </option>
        </select>
      </div>

      <!-- Ordena√ß√£o -->
      <div class="filter-group">
        <label>Ordenar por:</label>
        <select [(ngModel)]="filters.order_by" (change)="onFilterChange()">
          <option *ngFor="let option of filterOptions.order_options" [value]="option.value">
            {{option.label}}
          </option>
        </select>
      </div>

      <!-- Data De -->
      <div class="filter-group">
        <label>Data de:</label>
        <input type="date" [(ngModel)]="filters.date_from" (change)="onFilterChange()">
      </div>

      <!-- Data At√© -->
      <div class="filter-group">
        <label>Data at√©:</label>
        <input type="date" [(ngModel)]="filters.date_to" (change)="onFilterChange()">
      </div>
    </div>

    <div class="filters-actions">
      <button class="btn-clear" (click)="clearFilters()">
        üóëÔ∏è Limpar Filtros
      </button>
      <div class="results-info">
        {{totalHands}} m√£os encontradas
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-section">
    <div class="loading-spinner"></div>
    <p>Carregando hist√≥rico...</p>
  </div>

  <!-- Tabela de M√£os -->
  <div *ngIf="!loading" class="hands-table-container">
    <table class="hands-table">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>M√£o ID</th>
          <th>Torneio</th>
          <th>Posi√ß√£o</th>
          <th>Cartas</th>
          <th>A√ß√£o</th>
          <th>Board</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let hand of hands" class="hand-row">
          <td class="date-cell">
            {{formatDate(hand.date_played)}}
          </td>
          <td class="hand-id-cell">
            <span class="hand-id">{{hand.hand_id}}</span>
          </td>
          <td class="tournament-cell">
            <span *ngIf="hand.pokerstars_tournament_id" class="tournament-id">
              {{hand.pokerstars_tournament_id}}
            </span>
            <span *ngIf="!hand.pokerstars_tournament_id" class="no-tournament">
              Cash Game
            </span>
          </td>
          <td class="position-cell">
            <span class="position-badge" [class]="'position-' + (hand.hero_position || 'unknown')">
              {{hand.hero_position || '-'}}
            </span>
          </td>
          <td class="cards-cell">
            <span class="cards" [ngClass]="getCardClass(hand.hero_cards || '')">{{formatCards(hand.hero_cards || '')}}</span>
          </td>
          <td class="action-cell">
            <span class="action-badge" [class]="'action-' + (hand.hero_action || 'unknown')">
              {{hand.hero_action || '-'}}
            </span>
          </td>
          <td class="board-cell">
            <span class="board" [ngClass]="getCardClass(hand.board_cards || '')">{{formatCards(hand.board_cards || '')}}</span>
          </td>
          <td class="status-cell">
            <span class="status-badge" [class]="getGapStatusClass(getGapStatus(hand.ai_analysis || ''))">
              {{getGapStatusLabel(getGapStatus(hand.ai_analysis || ''))}}
            </span>
          </td>
          <td class="actions-cell">
            <button class="btn-analysis" (click)="openAnalysisModal(hand)">
              üîç Ver An√°lise
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Mensagem quando n√£o h√° m√£os -->
    <div *ngIf="hands.length === 0" class="no-hands">
      <div class="no-hands-icon">üÉè</div>
      <h3>Nenhuma m√£o encontrada</h3>
      <p>Tente ajustar os filtros ou fa√ßa upload de hand histories.</p>
    </div>
  </div>

  <!-- Pagina√ß√£o -->
  <div *ngIf="!loading && totalPages > 1" class="pagination">
    <button 
      class="pagination-btn" 
      [disabled]="currentPage === 1"
      (click)="onPageChange(currentPage - 1)">
      ‚Üê Anterior
    </button>

    <button 
      *ngFor="let page of getPageNumbers()"
      class="pagination-btn"
      [class.active]="page === currentPage"
      (click)="onPageChange(page)">
      {{page}}
    </button>

    <button 
      class="pagination-btn" 
      [disabled]="currentPage === totalPages"
      (click)="onPageChange(currentPage + 1)">
      Pr√≥xima ‚Üí
    </button>

    <div class="pagination-info">
      P√°gina {{currentPage}} de {{totalPages}} ({{totalHands}} m√£os)
    </div>
  </div>
</div>

<!-- Modal de An√°lise -->
<div *ngIf="showAnalysisModal" class="modal-overlay" (click)="closeAnalysisModal()">
  <div class="modal-content poker-analysis-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üé∞ Mesa Interativa - An√°lise Passo a Passo</h2>
      <button class="modal-close" (click)="closeAnalysisModal()">√ó</button>
    </div>

    <div *ngIf="selectedHand" class="modal-body">
      
      <!-- Loading da Mesa -->
      <div *ngIf="loadingReplay" class="replay-loading">
        <div class="loading-spinner"></div>
        <p>Carregando dados da m√£o para reprodu√ß√£o...</p>
      </div>

      <!-- Mesa de Poker Interativa -->
      <div *ngIf="!loadingReplay && handReplayData" class="poker-table-section">
        <app-poker-table 
          [handReplay]="handReplayData"
          [currentStreetIndex]="currentStreetIndex"
          [currentActionIndex]="currentActionIndex">
        </app-poker-table>
      </div>

      <!-- Erro ao carregar -->
      <div *ngIf="!loadingReplay && !handReplayData" class="replay-error">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h3>Erro ao carregar reprodu√ß√£o</h3>
        <p>N√£o foi poss√≠vel processar esta m√£o para reprodu√ß√£o interativa.</p>
        
        <!-- Fallback: An√°lise Tradicional -->
        <div class="fallback-analysis">
          <h4>üìã Informa√ß√µes B√°sicas</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="label">M√£o ID:</span>
              <span class="value">{{selectedHand.hand_id}}</span>
            </div>
            <div class="info-item">
              <span class="label">Posi√ß√£o:</span>
              <span class="value">{{selectedHand.hero_position || '-'}}</span>
            </div>
            <div class="info-item">
              <span class="label">Cartas:</span>
              <span class="value" [innerHTML]="formatCards(selectedHand.hero_cards || '')"></span>
            </div>
            <div class="info-item">
              <span class="label">A√ß√£o:</span>
              <span class="value">{{selectedHand.hero_action || '-'}}</span>
            </div>
          </div>
          
          <h4>ü§ñ An√°lise da IA</h4>
          <div class="analysis-content">
            <pre>{{selectedHand.ai_analysis || 'An√°lise n√£o dispon√≠vel'}}</pre>
          </div>
        </div>
      </div>

      <!-- Controles Adicionais -->
      <div *ngIf="handReplayData" class="additional-controls">
        <div class="control-section">
          <h4>üéØ An√°lise Espec√≠fica</h4>
          <button 
            class="btn-analyze-action" 
            (click)="analyzeCurrentAction()"
            [disabled]="analyzingAction">
            {{analyzingAction ? 'Analisando...' : 'üîç Analisar A√ß√£o Atual'}}
          </button>
        </div>

        <!-- Resultado da An√°lise Espec√≠fica -->
        <div *ngIf="currentActionAnalysis" class="action-analysis-result">
          <h4>üìä An√°lise da A√ß√£o</h4>
          <div class="analysis-content">
            <pre>{{currentActionAnalysis}}</pre>
          </div>
        </div>
      </div>

    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="resetReplay()" *ngIf="handReplayData">
        üîÑ Reiniciar Reprodu√ß√£o
      </button>
      <button class="btn-close" (click)="closeAnalysisModal()">
        Fechar
      </button>
    </div>
  </div>
</div>

