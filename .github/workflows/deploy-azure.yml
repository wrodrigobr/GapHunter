name: Deploy GapHunter to Azure App Service

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: gaphunter-rg
  AZURE_LOCATION: eastus
  BACKEND_APP_NAME: gaphunter-backend
  FRONTEND_APP_NAME: gaphunter-frontend-static
  POSTGRES_SERVER_NAME: gaphunter-postgres
  DATABASE_NAME: gaphunter
  APP_SERVICE_PLAN: gaphunter-plan

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ env.AZURE_RESOURCE_GROUP }} \
          --location ${{ env.AZURE_LOCATION }}

    - name: Create PostgreSQL Server and Database
      run: |
        # Check if PostgreSQL Server exists
        if ! az postgres flexible-server show --name ${{ env.POSTGRES_SERVER_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &> /dev/null; then
          echo "Creating PostgreSQL Flexible Server..."
          az postgres flexible-server create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.POSTGRES_SERVER_NAME }} \
            --location ${{ env.AZURE_LOCATION }} \
            --admin-user gaphunter \
            --admin-password "${{ secrets.DB_ADMIN_PASSWORD }}" \
            --sku-name Standard_B1ms \
            --tier Burstable \
            --storage-size 32 \
            --version 14 \
            --public-access 0.0.0.0
        fi
        
        # Check if database exists
        if ! az postgres flexible-server db show --database-name ${{ env.DATABASE_NAME }} --server-name ${{ env.POSTGRES_SERVER_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &> /dev/null; then
          echo "Creating database..."
          az postgres flexible-server db create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --server-name ${{ env.POSTGRES_SERVER_NAME }} \
            --database-name ${{ env.DATABASE_NAME }}
        fi

    - name: Create App Service Plan
      run: |
        if ! az appservice plan show --name ${{ env.APP_SERVICE_PLAN }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &> /dev/null; then
          az appservice plan create \
            --name ${{ env.APP_SERVICE_PLAN }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }} \
            --sku B1 \
            --is-linux
        fi

    - name: Create Backend App Service
      run: |
        if ! az webapp show --name ${{ env.BACKEND_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &> /dev/null; then
          az webapp create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --plan ${{ env.APP_SERVICE_PLAN }} \
            --name ${{ env.BACKEND_APP_NAME }} \
            --runtime "PYTHON|3.11"
        fi

    - name: Configure Backend App Settings
      run: |
        DATABASE_URL="postgresql://gaphunter:${{ secrets.DB_ADMIN_PASSWORD }}@${{ env.POSTGRES_SERVER_NAME }}.postgres.database.azure.com:5432/${{ env.DATABASE_NAME }}"
        
        az webapp config appsettings set \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.BACKEND_APP_NAME }} \
          --settings \
          DATABASE_URL="$DATABASE_URL" \
          SECRET_KEY="${{ secrets.SECRET_KEY }}" \
          OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}" \
          ENVIRONMENT="production" \
          SCM_DO_BUILD_DURING_DEPLOYMENT=true \
          ENABLE_ORYX_BUILD=true

    - name: Configure Backend Startup
      run: |
        az webapp config set \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.BACKEND_APP_NAME }} \
          --startup-file "python startup.py"

    - name: Deploy Backend Code
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.BACKEND_APP_NAME }}
        package: './backend'

    - name: Create Static Web App (Frontend)
      run: |
        if ! az staticwebapp show --name ${{ env.FRONTEND_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &> /dev/null; then
          az staticwebapp create \
            --name ${{ env.FRONTEND_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }} \
            --source "https://github.com/${{ github.repository }}" \
            --branch ${{ github.ref_name }} \
            --app-location "/frontend" \
            --output-location "dist" \
            --login-with-github
        fi

    - name: Get Application URLs
      id: app-urls
      run: |
        BACKEND_URL=$(az webapp show --name ${{ env.BACKEND_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "defaultHostName" --output tsv)
        FRONTEND_URL=$(az staticwebapp show --name ${{ env.FRONTEND_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "defaultHostname" --output tsv)
        
        echo "backend-url=$BACKEND_URL" >> $GITHUB_OUTPUT
        echo "frontend-url=$FRONTEND_URL" >> $GITHUB_OUTPUT

    - name: Wait for Backend to be Ready
      run: |
        echo "Aguardando backend ficar online..."
        sleep 120
        
        # Test backend health
        for i in {1..10}; do
          if curl -f "https://${{ steps.app-urls.outputs.backend-url }}/health" &> /dev/null; then
            echo "Backend est√° online!"
            break
          fi
          echo "Tentativa $i/10 - aguardando..."
          sleep 30
        done

    - name: Run Database Migrations
      run: |
        # Try to run migrations
        curl -X POST "https://${{ steps.app-urls.outputs.backend-url }}/admin/migrate" || echo "Migrations may need to be run manually"

    - name: Display Deployment Info
      run: |
        echo "üéâ Deployment completed successfully!"
        echo ""
        echo "üåê Application URLs:"
        echo "Frontend: https://${{ steps.app-urls.outputs.frontend-url }}"
        echo "Backend:  https://${{ steps.app-urls.outputs.backend-url }}"
        echo "API Docs: https://${{ steps.app-urls.outputs.backend-url }}/docs"
        echo ""
        echo "üí∞ Cost-optimized App Service configuration:"
        echo "- Azure Database for PostgreSQL: Burstable B1ms (~$12/month)"
        echo "- App Service Plan: B1 Basic (~$13/month)"
        echo "- Static Web App: FREE"
        echo "- Total estimated cost: ~$25/month"

